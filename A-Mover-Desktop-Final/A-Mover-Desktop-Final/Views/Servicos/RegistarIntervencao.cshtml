@model A_Mover_Desktop_Final.Models.Servico

@{
    ViewData["Title"] = "Registar Intervenção";
}

<div class="card m-5 p-4">
    <h2 class="text-primary mb-4"><i class="bi bi-tools"></i> Registar Nova Intervenção</h2>

    <form asp-action="RegistarIntervencao" method="post">
        <div class="mb-3">
            <label class="form-label">Mota (Nº Identificação)</label>
            <div class="input-group">
                <input id="inputMota" class="form-control" autocomplete="off" 
                       placeholder="Digite o número de identificação ou parte dele..." />
                <button class="btn btn-outline-secondary" type="button" id="btnLimpar">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div id="resultadosBusca" class="mt-2">
                <select id="selectMota" class="form-select" size="5" style="display: none;"></select>
            </div>
            <input type="hidden" id="hiddenIDMota" name="IDMota" required />
            <div id="motaSelecionadaInfo" class="alert alert-info mt-2" style="display: none;"></div>
            <div id="erroMota" class="text-danger mt-1"></div>
        </div>

        <div class="mb-3">
            <label asp-for="Tipo" class="form-label">Tipo de Serviço</label>
            <select asp-for="Tipo" class="form-select" required>
                <option value="">Selecione...</option>
                <option value="0">Revisão</option>
                <option value="1">Manutenção</option>
            </select>
        </div>

        <div class="mb-3">
            <label asp-for="Descricao" class="form-label">Descrição</label>
            <textarea asp-for="Descricao" class="form-control" rows="3"></textarea>
        </div>

        <input type="hidden" asp-for="DataServico" value="@DateTime.Now.ToString("yyyy-MM-dd")" />
        <input type="hidden" asp-for="Estado" value="1" /> @* EmCurso *@

        <button type="submit" class="btn btn-primary" id="btnSubmit" disabled>
            <i class="bi bi-play-circle"></i> Iniciar Serviço
        </button>
        <a asp-action="Index" class="btn btn-secondary ms-2">Cancelar</a>
    </form>
</div>

@section Scripts {
    <script>
        const input = document.getElementById("inputMota");
        const select = document.getElementById("selectMota");
        const hidden = document.getElementById("hiddenIDMota");
        const btnLimpar = document.getElementById("btnLimpar");
        const btnSubmit = document.getElementById("btnSubmit");
        const erroMota = document.getElementById("erroMota");
        const motaInfo = document.getElementById("motaSelecionadaInfo");
        
        // Função para buscar motas
        let timeoutId;
        input.addEventListener("input", function() {
            const termo = this.value.trim();
            
            // Limpar o timeout anterior para evitar múltiplas requisições
            clearTimeout(timeoutId);
            
            // Resetar os campos se o input estiver vazio
            if (termo.length === 0) {
                limparCampos();
                return;
            }
            
            // Definir um timeout para buscar apenas após o usuário parar de digitar
            timeoutId = setTimeout(() => {
                if (termo.length >= 2) {
                    erroMota.textContent = "Buscando...";
                    fetch(`/Servicos/ObterMotasPorIdentificacao?termo=${encodeURIComponent(termo)}`)
                        .then(response => response.json())
                        .then(data => {
                            select.innerHTML = "";
                            erroMota.textContent = "";
                            
                            if (data.length > 0) {
                                data.forEach(item => {
                                    const option = document.createElement("option");
                                    option.value = item.id;
                                    option.textContent = `${item.texto} - ${item.infoAdicional || 'Sem informações adicionais'}`;
                                    option.dataset.info = JSON.stringify(item);
                                    select.appendChild(option);
                                });
                                select.style.display = "block";
                            } else {
                                select.style.display = "none";
                                erroMota.textContent = "Nenhuma mota encontrada com este número.";
                            }
                        })
                        .catch(error => {
                            erroMota.textContent = "Erro ao buscar motas. Tente novamente.";
                            console.error("Erro:", error);
                        });
                } else {
                    select.style.display = "none";
                    erroMota.textContent = "Digite pelo menos 2 caracteres para buscar.";
                }
            }, 300); // 300ms delay para melhorar performance
        });

        // Selecionar mota da lista - SUBSTITUIR ESTA PARTE
        select.addEventListener("click", function(e) {  // Mudado de "change" para "click"
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption) {
                const itemInfo = JSON.parse(selectedOption.dataset.info);
                input.value = selectedOption.textContent.split(" - ")[0];
                hidden.value = selectedOption.value;
                select.style.display = "none";
                
                // Exibir informações adicionais da mota selecionada
                motaInfo.innerHTML = `
                    <strong>Mota Selecionada:</strong> ${itemInfo.texto}<br>
                    <strong>Modelo:</strong> ${itemInfo.modelo || 'N/A'}<br>
                    <strong>Cor:</strong> ${itemInfo.cor || 'N/A'}<br>
                    <strong>Estado:</strong> ${itemInfo.estado || 'N/A'}
                `;
                motaInfo.style.display = "block";
                btnSubmit.disabled = false;
            }
        });
        
        // Adicionar um evento de clique duplo como alternativa
        select.addEventListener("dblclick", function(e) {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption) {
                // Mesmo código acima para seleção
                const itemInfo = JSON.parse(selectedOption.dataset.info);
                input.value = selectedOption.textContent.split(" - ")[0];
                hidden.value = selectedOption.value;
                select.style.display = "none";
                
                motaInfo.innerHTML = `
                    <strong>Mota Selecionada:</strong> ${itemInfo.texto}<br>
                    <strong>Modelo:</strong> ${itemInfo.modelo || 'N/A'}<br>
                    <strong>Cor:</strong> ${itemInfo.cor || 'N/A'}<br>
                    <strong>Estado:</strong> ${itemInfo.estado || 'N/A'}
                `;
                motaInfo.style.display = "block";
                btnSubmit.disabled = false;
                
                // Envia o formulário automaticamente ao clicar duas vezes
                // Descomente a linha abaixo se desejar este comportamento
                // document.querySelector("form").submit();
            }
        });
        
        // Limpar campo de busca
        btnLimpar.addEventListener("click", limparCampos);
        
        function limparCampos() {
            input.value = "";
            hidden.value = "";
            select.style.display = "none";
            motaInfo.style.display = "none";
            erroMota.textContent = "";
            btnSubmit.disabled = true;
        }
        
        // Validar envio do formulário
        document.querySelector("form").addEventListener("submit", function(e) {
            if (!hidden.value) {
                e.preventDefault();
                erroMota.textContent = "Selecione uma mota válida para continuar.";
            }
        });
    </script>
}
